
const BASE=(window.SITE_BASE||'/').replace(/\/?$/,'/');const CONTENT_DIR='content',POSTS_DIR=CONTENT_DIR+'/posts',PROJECTS_DIR=CONTENT_DIR+'/projects',POSTS_MANIFEST=POSTS_DIR+'/posts.json',PROJECTS_MANIFEST=PROJECTS_DIR+'/projects.json';const $=(q,e=document)=>e.querySelector(q),html=(s,...v)=>s.reduce((a,b,i)=>a+b+(v[i]??''),''),H=p=>BASE+p.replace(/^\//,'');function pathRel(){const r=new RegExp('^'+BASE.replace(/\//g,'\\/'));const p=location.pathname.replace(r,'/');return p||'/'}function q(){return Object.fromEntries(new URLSearchParams(location.search).entries())}function slugify(t){return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-').replace(/-+/g,'-')}function parseFrontMatter(md){const m=md.match(/^---\s*[\r\n]+([\s\S]*?)\r?\n---\s*[\r\n]+/);if(!m)return{attrs:{},body:md};const raw=m[1],body=md.slice(m[0].length);const attrs={};raw.split(/\r?\n/).forEach(l=>{const x=l.match(/^([A-Za-z0-9_-]+):\s*(.*)$/);if(x){let v=x[2].trim();if(/^\[.*\]$/.test(v)){try{v=JSON.parse(v.replace(/'/g,'"'))}catch{}}else v=v.replace(/^"(.*)"$/,'$1').replace(/^'(.*)'$/,'$1');attrs[x[1]]=v}});return{attrs,body}}async function loadText(p){const r=await fetch(p,{cache:'no-store'});if(!r.ok)throw new Error('No se pudo cargar '+p+' ('+r.status+')');return r.text()}function buildTOC(c){const hs=[...c.querySelectorAll('h2,h3')];if(!hs.length){$('#toc-root').innerHTML='';return}hs.forEach(h=>{if(!h.id)h.id=slugify(h.textContent)});const toc=document.createElement('nav');toc.className='toc';toc.innerHTML='<h2>Contenido</h2>';const ul=document.createElement('ul');hs.forEach(h=>{const li=document.createElement('li');const a=document.createElement('a');a.href='#'+h.id;a.textContent=h.textContent;li.appendChild(a);ul.appendChild(li)});toc.appendChild(ul);const root=$('#toc-root');root.innerHTML='';root.appendChild(toc)}function enhance(t){[...t.querySelectorAll('a[href]')].forEach(a=>{if(/^https?:\/\//i.test(a.href))a.setAttribute('target','_blank')});if(window.hljs)t.querySelectorAll('pre code').forEach(c=>window.hljs.highlightElement(c));t.querySelectorAll('img,h2,h3').forEach(x=>x.classList.add('reveal'));buildTOC(t);attachReveal(t)}function renderMarkdown(md,el){marked.setOptions({gfm:true,breaks:true});const {attrs,body}=parseFrontMatter(md);el.innerHTML=marked.parse(body||md);enhance(el);return attrs}function routeEnterAnimate(){const el=$('#content');if(!el)return;el.classList.remove('route-enter');void el.offsetWidth;el.classList.add('route-enter')}const _revealObserver=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in');_revealObserver.unobserve(e.target)}})},{threshold:.1});function attachReveal(r=document){r.querySelectorAll('.reveal').forEach(el=>_revealObserver.observe(el))}(function(){const k='theme',s=localStorage.getItem(k);if(s==='light')document.body.classList.add('theme-light');const b=$('#themeToggle');b&&b.addEventListener('click',()=>{const L=document.body.classList.toggle('theme-light');localStorage.setItem(k,L?'light':'dark')})})();(function(){const a=new Audio();a.src='assets/music/tema.mp3';a.loop=true;a.preload='auto';const k1='bgm:on',k2='bgm:vol',b=$('#musicToggle'),v=$('#musicVol');const sv=parseFloat(localStorage.getItem(k2)||'0.5');a.volume=isNaN(sv)?0.5:sv;v&&(v.value=String(a.volume));const setI=on=>b&&(b.textContent=on?'‚è∏Ô∏è':'üéµ');let on=localStorage.getItem(k1)==='1';setI(on);async function play(){try{await a.play()}catch(e){}}if(on)play();b&&b.addEventListener('click',async()=>{on=!on;localStorage.setItem(k1,on?'1':'0');setI(on);if(on)await play();else a.pause()});v&&v.addEventListener('input',()=>{const w=parseFloat(v.value);a.volume=w;localStorage.setItem(k2,String(w))})})();async function renderPage(name){const el=$('#content');try{const md=await loadText(CONTENT_DIR+'/'+name+'.md');renderMarkdown(md,el);routeEnterAnimate()}catch(e){$('#toc-root').innerHTML='';el.innerHTML='<p>Error: '+e.message+'</p>'}}async function renderList(manifest,base,title,kind,tag){const el=$('#content');try{const res=await fetch(manifest,{cache:'no-store'});if(!res.ok)throw new Error('No se pudo cargar '+manifest);let items=await res.json();const page=parseInt((q().page||'1'));const per=kind==='post'?5:8;if(tag)items=items.filter(p=>(p.tags||[]).map(t=>String(t).toLowerCase()).includes(tag.toLowerCase()));items.sort((a,b)=>(b.date||'').localeCompare(a.date||''));const total=Math.max(1,Math.ceil(items.length/per));const pg=Math.min(Math.max(1,page),total);const start=(pg-1)*per;const list=items.slice(start,start+per);const tags=Array.from(new Set(items.flatMap(p=>(p.tags||[])))).sort();$('#toc-root').innerHTML='';el.innerHTML=html`<h1>${title}</h1>${tags.length?`<div class="badges" style="margin:8px 0 12px 0;">${tags.map(t=>`<a class="badge" href="${H(kind==='post'?'posts':'projects')}?tag=${encodeURIComponent(t)}">${t}</a>`).join('')}</div>`:''}<div class="grid">${list.map(p=>html`<a class="card reveal" href="${H('/'+kind+'/'+p.slug)}"><h3>${p.title}</h3><div class="meta">${p.date??''} ${p.reading?`‚Ä¢ ${p.reading}`:''}</div><p class="project-excerpt">${p.excerpt??''}</p><div class="badges">${(p.tags||[]).map(t=>`<span class="badge">${t}</span>`).join('')}</div></a>`).join('')}</div><div class="pagination">${pg>1?`<a href="${H(kind==='post'?'posts':'projects')}?${tag?`tag=${encodeURIComponent(tag)}&`:''}page=${pg-1}">‚Üê Anterior</a>`:'<span class="placeholder"></span>'}<span class="current">P√°gina ${pg} de ${total}</span>${pg<total?`<a href="${H(kind==='post'?'posts':'projects')}?${tag?`tag=${encodeURIComponent(tag)}&`:''}page=${pg+1}">Siguiente ‚Üí</a>`:''}</div>`;attachReveal(el);routeEnterAnimate()}catch(e){$('#toc-root').innerHTML='';el.innerHTML='<p>Error: '+e.message+'</p>'}}async function renderItem(slug,manifest,base,backHref,backText){const el=$('#content');try{const items=await (await fetch(manifest,{cache:'no-store'})).json();const meta=items.find(x=>x.slug===slug);if(!meta)throw new Error('No encontrado: '+slug);const md=await loadText(base+'/'+meta.file);const attrs=renderMarkdown(md,el);const title=attrs.title||meta.title||slug;const date=attrs.date||meta.date||'';const tags=Array.isArray(attrs.tags)?attrs.tags:(attrs.tags?[attrs.tags]:(meta.tags||[]));el.insertAdjacentHTML('afterbegin',html`<div class="breadcrumbs"><a href="${backHref}">‚Üê ${backText}</a></div><h1>${title}</h1>${date?`<div class="project-meta">${date}</div>`:''}${tags.length?`<div class="badges">${tags.map(t=>`<span class="badge">${t}</span>`).join('')}</div>`:''}<hr style="margin:16px 0; border-color:#1a2337;">`);buildTOC(el);routeEnterAnimate()}catch(e){$('#toc-root').innerHTML='';el.innerHTML='<p>Error: '+e.message+'</p>'}}let _lunrIndex=null,_lunrDocs=[];async function buildSearch(){if(_lunrIndex)return;const posts=await (await fetch(POSTS_MANIFEST,{cache:'no-store'})).json();const projects=await (await fetch(PROJECTS_MANIFEST,{cache:'no-store'})).json();let id=0;_lunrDocs=[...posts.map(p=>({id:String(id++),type:'post',title:p.title,excerpt:p.excerpt||'',tags:(p.tags||[]).join(' '),slug:p.slug})),...projects.map(p=>({id:String(id++),type:'project',title:p.title,excerpt:p.excerpt||'',tags:(p.tags||[]).join(' '),slug:p.slug}))];_lunrIndex=lunr(function(){this.ref('id');this.field('title',{boost:3});this.field('excerpt');this.field('tags',{boost:2});_lunrDocs.forEach(d=>this.add(d))})}async function renderSearch(){const el=$('#content');await buildSearch();const s=q().q||'';$('#toc-root').innerHTML='';el.innerHTML=html`<h1>Buscar</h1><form class="search-bar" id="sf" action="${H('/search')}" method="get"><input name="q" id="si" class="search-input" type="search" placeholder="Buscar..." value="${s}"/><button class="search-btn" type="submit">Buscar</button></form><div id="sr" class="grid"></div>`;const r=$('#sr');function doSearch(x){r.innerHTML='';const res=_lunrIndex.search((x||'').trim());const docs=res.map(o=>_lunrDocs.find(d=>d.id===o.ref));r.innerHTML=docs.map(d=>html`<a class="card reveal" href="${H('/'+d.type+'/'+d.slug)}"><h3>${d.title}</h3><p class="project-excerpt">${d.excerpt}</p><div class="badges">${d.tags.split(' ').filter(Boolean).map(t=>`<span class="badge">${t}</span>`).join('')}</div></a>`).join('')||'<p>Sin resultados.</p>';attachReveal(r);routeEnterAnimate()}if(s)doSearch(s)}function currentRoute(){const p=pathRel();const params=q();const m1=p.match(/^\/post\/([^/?#]+)/),m2=p.match(/^\/project\/([^/?#]+)/);if(m1)return{name:'post',slug:m1[1]};if(m2)return{name:'project',slug:m2[1]};const base=(p.match(/^\/([^/?#]+)/)||[])[1]||'home';return{name:base,query:params}}async function router(){const r=currentRoute();if(r.name==='posts')return renderList(POSTS_MANIFEST,POSTS_DIR,'Posts','post',r.query.tag);if(r.name==='projects')return renderList(PROJECTS_MANIFEST,PROJECTS_DIR,'Proyectos','project',r.query.tag);if(r.name==='post')return renderItem(r.slug,POSTS_MANIFEST,POSTS_DIR,H('/posts'),'Volver a Posts');if(r.name==='project')return renderItem(r.slug,PROJECTS_MANIFEST,PROJECTS_DIR,H('/projects'),'Volver a Proyectos');if(r.name==='search')return renderSearch();return renderPage(r.name)}window.addEventListener('popstate',router);window.addEventListener('DOMContentLoaded',router);document.addEventListener('click',e=>{const a=e.target.closest('a[href]');if(!a)return;const href=a.getAttribute('href');if(href.startsWith('http')||href.startsWith('mailto:')||href.startsWith('#'))return;e.preventDefault();history.pushState({},'',href);router()});(function(){const s=$('#sidebar'),t=$('#navToggle'),b=$('#backdrop'),n=$('#mainNav');if(!s||!t||!b)return;const mq=window.matchMedia('(max-width: 1024px)');function open(){s.classList.add('is-open');b.hidden=false;t.setAttribute('aria-expanded','true')}function close(){s.classList.remove('is-open');b.hidden=true;t.setAttribute('aria-expanded','false')}function sync(e){if(e.matches)close();else{close();b.hidden=true}}mq.addEventListener?mq.addEventListener('change',sync):mq.addListener(sync);sync(mq);t.addEventListener('click',()=>s.classList.contains('is-open')?close():open());b.addEventListener('click',close);window.addEventListener('keydown',e=>{if(e.key==='Escape')close()});n&&n.addEventListener('click',e=>{if(e.target.closest("a[href^='/']"))close()})})();